alertmanager:
  config:
    global:
      resolve_timeout: 5m
    route:
      group_by: ['alertname', 'instance']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'email'
      routes:
      - match:
          alertname: Watchdog
        receiver: 'null'
      - match:
          alertname: CPUThrottlingHigh
        receiver: 'email'
    receivers:
    - name: 'null'
    - name: 'email'
      email_configs:
      - to: $GMAIL_ACCOUNT
        from: $GMAIL_ACCOUNT
        smarthost: "smtp.gmail.com:587"
        auth_username: "$GMAIL_ACCOUNT"
        auth_identity: "$GMAIL_ACCOUNT"
        auth_password: "$GMAIL_AUTH_TOKEN"

prometheus:
  prometheusSpec:
    podAntiAffinity: "hard"
    secrets:
      - etcd-client
    ruleSelector:
      matchLabels:
        app: prometheus-operator
        release: monitoring
    enableAdminAPI: true
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: thin-disk
          accessModes: ["ReadWriteOnce"]
          resources:
            requests:
              storage: 5Gi
        selector:
          matchExpressions:
            - key: app
              operator: In
              values:
                - prometheus
                - bosh-exporter

additionalPrometheusRules:
- name: kube-api-rules-file
  groups:
  - name: kubeapi_rules
    interval: 15s
    rules:
    - record: "kubernetes:job_verb:apiserver_latency:pctl90rate5m"
      expr: "histogram_quantile ( 0.90, sum by (le, verb)( rate(apiserver_request_latencies_bucket[5m]) ) ) / 1e3 > 0"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes:job_verb_instance:apiserver_latency:pctl90rate5m"
      expr: "histogram_quantile ( 0.90, sum by (le, job, verb, instance)( rate(apiserver_request_latencies_bucket[5m]) ) ) / 1e3"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job:probe_success"
      expr: "sum by()(probe_success{provider=\"kubernetes\", component=\"apiserver\"})"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job_verb_code:apiserver_requests:rate5m"
      expr: "sum without (instance)(kubernetes:job_verb_code_instance:apiserver_requests:rate5m)"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes:job_verb_code_instance:apiserver_requests:rate5m"
      expr: "sum by (job, verb, code, instance)(rate(apiserver_request_count[5m]))"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job_verb_code:apiserver_requests:ratio_rate5m"
      expr: "sum without (instance)(kubernetes:job_verb_code_instance:apiserver_requests:ratio_rate5m)"
      labels:
        job: kubernetes_api_slo
    - record: "kubernetes:job_verb_code_instance:apiserver_requests:ratio_rate5m"
      expr: "kubernetes:job_verb_code_instance:apiserver_requests:rate5m / ignoring(verb, code) group_left sum by (job, instance)(kubernetes:job_verb_code_instance:apiserver_requests:rate5m)"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes:job:apiserver_request_errors:ratio_rate5m"
      expr: "sum by (job)(kubernetes:job_verb_code_instance:apiserver_requests:ratio_rate5m{verb=~\"GET|POST|DELETE|PATCH\", code=~\"5..\"})"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job:apiserver_latency:pctl90rate5m"
      expr: "histogram_quantile ( 0.90, sum by (le, job)( rate(apiserver_request_latencies_bucket{verb=~\"GET|POST|DELETE|PATCH\"}[5m]) ) ) / 1e3"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job:slo_kube_api_ok"
      expr: "kubernetes:job:apiserver_request_errors:ratio_rate5m < bool 0.01 * kubernetes::job:apiserver_latency:pctl90rate5m < bool 200"
      labels:
        job: "kubernetes_api_slo"
    - record: "kubernetes::job:slo_kube_api_sample"
      expr: "kubernetes:job:apiserver_request_errors:ratio_rate5m < bool Inf * kubernetes::job:apiserver_latency:pctl90rate5m < bool Inf"
      labels:
        job: "kubernetes_api_slo"

grafana:
  dashboardProviders:
    dashboardproviders.yaml:
      apiVersion: 1
      providers:
      - name: 'kubeapislo'
        type: file
        updateIntervalSeconds: 10
        disableDeletion: true
        editable: true
        options:
          path: /var/lib/grafana/dashboards/kubeapislo
      - name: 'pkscontrolplane'
        type: file
        updateIntervalSeconds: 10
        disableDeletion: true
        editable: true
        options:
          path: /var/lib/grafana/dashboards/pkscontrolplane

  dashboards:
    kubeapislo:
      kubeapi-slo:
        file: dashboards/kubeapi-slo.json
    pkscontrolplane:
      pks-control-plane:
        file: dashboards/pks-control-plane.json

  notifiers: 
    notifiers.yaml:
      notifiers:
      - name: email-notifier
        type: email
        uid: email1
        org_id: 1
        is_default: true
        settings:
          addresses: "$GMAIL_ACCOUNT"

  smtp:
    existingSecret: "smtp-creds"
    userKey: "user"
    passwordKey: "password"

  grafana.ini:
    smtp:
      enabled: true
      host: "smtp.gmail.com:587"
      user: "$GMAIL_ACCOUNT"
      password: "$GMAIL_AUTH_TOKEN"
